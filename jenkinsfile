def TEST_STATUS = false
def BUILD_STATUS = false
pipeline {
   agent any
   stages {
       stage('pull app from SC'){
           steps{
               dir('todo') {
                   git url: 'https://github.com/dobromir-hristov/todo-app.git'
                   sh 'mv ../Dockerfile .'
                   sh 'docker build --no-cache -t todo-main .'
               }
           }
       }
        stage('app build stage and archive build-output') {
            steps{
                dir("${env.WORKSPACE}/todo"){
                    script{
                        withEnv(["CMD=build"]) {
                            BUILD_STATUS = sh (
                                script: "docker run --tty --name todo-build todo-main build",
                                returnStatus: true
                            ) == 0
                        }
                    }
                }
            }
            post { 
                always { 
                    sh 'docker logs todo-build > build-output.log'
                    archiveArtifacts artifacts: 'build-output.log'
                }
            }
        }
        stage('app lint stage') {
            steps{
                dir("${env.WORKSPACE}/todo"){
                    script{
                        withEnv(["CMD=build"]) {
                            BUILD_STATUS = sh (
                                script: "docker run --tty --name todo-lint todo-main lint",
                                returnStatus: true
                            ) == 0
                        }
                    }
                }
            }
        }
        stage('app testing stage') {
            when{
                expression { BUILD_STATUS }
            }
            steps {
                dir("${env.WORKSPACE}/todo"){
                    script{
                        withEnv(["CMD=test"]) {
                            TEST_STATUS = sh (
                                script: "docker run --tty --name todo-test todo-main test:unit",
                                returnStatus: true
                            ) == 0
                        }
                    }
                }
            }
        }
    }
}